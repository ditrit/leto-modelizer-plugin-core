

<!DOCTYPE html>
<html lang="en">

<head>
  tracking-code-which-will-go-to-the-HEAD
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> draw/DefaultDrawer.js</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="./build/entry.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="style.css">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
             
                <a href="index.html">
                    <h1 class="navbar-item">leto-modelizer-plugin-core</h1>
                </a>
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    Documentation
                </a>
                
                 
                    
                        <a
                            class="link user-link "
                            href="https://github.com/ditrit/leto-modelizer-plugin-core#README.md"
                        >
                            Github
                        </a>
                    
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
                <div class="search-wrapper">
                    <input id="search" type="text" placeholder="Search docs..." class="input">
                </div>
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Classes</h3><ul><li><a href="Action.html">Action</a></li><li><a href="Component.html">Component</a></li><li><a href="ComponentAttribute.html">ComponentAttribute</a></li><li><a href="ComponentAttributeDefinition.html">ComponentAttributeDefinition</a></li><li><a href="ComponentDefinition.html">ComponentDefinition</a></li><li><a href="ComponentDrawOption.html">ComponentDrawOption</a></li><li><a href="ComponentLink.html">ComponentLink</a></li><li><a href="ComponentLinkDefinition.html">ComponentLinkDefinition</a></li><li><a href="ComponentRenderer.html">ComponentRenderer</a></li><li><a href="ComponentTemporaryLink.html">ComponentTemporaryLink</a></li><li><a href="CustomLayout.html">CustomLayout</a></li><li><a href="DefaultConfiguration.html">DefaultConfiguration</a></li><li><a href="DefaultData.html">DefaultData</a></li><li><a href="DefaultDrawer.html">DefaultDrawer</a></li><li><a href="DefaultLayout.html">DefaultLayout</a></li><li><a href="DefaultMetadata.html">DefaultMetadata</a></li><li><a href="DefaultParser.html">DefaultParser</a></li><li><a href="DefaultPlugin.html">DefaultPlugin</a></li><li><a href="DefaultRender.html">DefaultRender</a></li><li><a href="DeleteAction.html">DeleteAction</a></li><li><a href="DeselectionAllAction.html">DeselectionAllAction</a></li><li><a href="DragComponentAction.html">DragComponentAction</a></li><li><a href="DragSceneAction.html">DragSceneAction</a></li><li><a href="EventLog.html">EventLog</a></li><li><a href="FileInformation.html">FileInformation</a></li><li><a href="FileInput.html">FileInput</a></li><li><a href="LinkAction.html">LinkAction</a></li><li><a href="LinkRenderer.html">LinkRenderer</a></li><li><a href="MenuAction.html">MenuAction</a></li><li><a href="ParseError.html">ParseError</a></li><li><a href="ResizeComponentAction.html">ResizeComponentAction</a></li><li><a href="SelectionAllAction.html">SelectionAllAction</a></li><li><a href="Tag.html">Tag</a></li><li><a href="ToggleSelectionAction.html">ToggleSelectionAction</a></li><li><a href="Variable.html">Variable</a></li><li><a href="ZoomAction.html">ZoomAction</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>draw/DefaultDrawer.js</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import * as d3 from 'd3';
import DeleteAction from './action/DeleteAction';
import DragComponentAction from './action/DragComponentAction';
import DragSceneAction from './action/DragSceneAction';
import LinkAction from './action/LinkAction';
import MenuAction from './action/MenuAction';
import ResizeComponentAction from './action/ResizeComponentAction';
import ToggleSelectionAction from './action/ToggleSelectionAction';
import DeselectionAllAction from './action/DeselectionAllAction';
import SelectionAllAction from './action/SelectionAllAction';
import ZoomAction from './action/ZoomAction';
import ComponentRenderer from './render/ComponentRenderer';
import LinkRenderer from './render/LinkRenderer';
import CustomLayout from './layout/CustomLayout';

/**
 * Class that draws a component in a graphical representation.
 */
class DefaultDrawer {
  /**
   * Default constructor
   * @param {DefaultData} pluginData - Plugin data storage.
   */
  constructor(pluginData) {
    /**
     * Plugin data storage.
     * @type {DefaultData}
     */
    this.pluginData = pluginData;

    /**
     * Component renderer.
     */
    this.componentRenderer = null;

    /**
     * Link renderer.
     */
    this.linkRenderer = null;

    /**
     * Plugin layout system.
     * @type {DefaultLayout}
     */
    this.layout = null;

    /**
     * D3 selection of the view port.
     * @type {Selection}
     */
    this.viewport = null;

    /**
     * D3 selection of the main scene.
     * @type {Selection}
     */
    this.scene = null;

    /**
     * D3 library.
     * @type {object}
     */
    this.d3 = d3;

    /**
     * Object to store all instances of actions.
     * @type {object}
     */
    this.actions = {
      deleteAction: null,
      dragComponent: null,
      dragScene: null,
      linkAction: null,
      menuAction: null,
      resizeComponent: null,
      toggleSelection: null,
      selectionAll: null,
      deselectionAll: null,
      zoom: null,
    };

    /**
     * Object to store all states of the scene.
     * @type {object}
     */
    this.states = {
      linking: false,
      menuOpening: false,
      moving: false,
      resizing: false,
      selection: false,
    };
    this.readOnly = false;
  }

  /**
   * Initialize drawing context.
   * @param {string} id - Html id of div that will be the drawing container.
   * @param {boolean} readOnly - Indicate if user can make action or modify the scene.
   */
  init(id, readOnly = false) {
    this.d3.select(`#${id}`).selectAll(null).remove();
    this.d3.select(`#${id}`).html('');
    this.viewport = this.d3.select(`#${id}`);

    this.componentRenderer = this.initComponentRenderer(readOnly);
    this.linkRenderer = this.initLinkRenderer(readOnly);
    this.layout = new CustomLayout(
      this.pluginData,
      this.viewport,
    );
    this.readOnly = readOnly;
    this.clearActions();

    if (this.readOnly) {
      this.pluginData.scene.x = 0;
      this.pluginData.scene.y = 0;
      this.pluginData.scene.zoom = 1;
    }

    this.initActions();
    this.initScene();
  }

  /**
   * Initialize component renderer and return instance of it.
   * @param {boolean} readOnly - Indicate if user can make action or modify the scene.
   * @returns {ComponentRenderer} New instance of ComponentRenderer.
   */
  initComponentRenderer(readOnly) {
    return new ComponentRenderer(this.pluginData, this.viewport, readOnly);
  }

  /**
   * Initialize link renderer and return instance of it.
   * @param {boolean} readOnly - Indicate if user can make action or modify the scene.
   * @returns {LinkRenderer} New instance of LinkRenderer.
   */
  initLinkRenderer(readOnly) {
    return new LinkRenderer(this.pluginData, this.viewport, readOnly);
  }

  /**
   * Remove all instances of actions and remove all set events.
   */
  clearActions() {
    this.actions.deleteAction = null;
    this.actions.dragComponent = null;
    this.actions.dragScene = null;
    this.actions.menuAction = null;
    this.actions.resizeComponent = null;
    this.actions.toggleSelection = null;
    this.actions.selectionAll = null;
    this.actions.deselectionAll = null;
    this.actions.zoom = null;

    this.viewport.on('wheel', null);
    this.d3.select('body')
      .on('keydown', null)
      .on('keyup', null);
    this.viewport.on('.drag', null);
  }

  /**
   * Initialize actions and set event on viewport and other.
   */
  initActions() {
    this.actions.selectionAll = new SelectionAllAction(this.pluginData, this.viewport, this.layout);
    this.actions.deleteAction = new DeleteAction(this.pluginData, this.viewport, this.layout);
    this.actions.dragScene = new DragSceneAction(this.pluginData, this.viewport, this.layout);
    this.actions.menuAction = new MenuAction(this.pluginData, this.viewport, this.layout);
    this.actions.link = new LinkAction(this.pluginData, this.viewport, this.layout);
    this.actions.zoom = new ZoomAction(this.pluginData, this.viewport, this.layout);
    this.actions.dragComponent = new DragComponentAction(
      this.pluginData,
      this.viewport,
      this.layout,
    );
    this.actions.resizeComponent = new ResizeComponentAction(
      this.pluginData,
      this.viewport,
      this.layout,
    );
    this.actions.toggleSelection = new ToggleSelectionAction(
      this.pluginData,
      this.viewport,
      this.layout,
    );
    this.actions.deselectionAll = new DeselectionAllAction(
      this.pluginData,
      this.viewport,
      this.layout,
    );

    this.viewport.on('wheel', (event) => {
      const haveToDraw = this.actions.zoom.execute(event);

      if (haveToDraw) {
        this.draw();
      }
    });

    if (!this.readOnly) {
      this.d3.select('body')
        .on('keydown', (event) => {
          let haveToDraw = false;

          if (this.pluginData.configuration.keysBinding.selection.includes(event.key)) {
            this.states.selection = true;
          }
          if (this.pluginData.configuration.keysBinding.deleteObject.includes(event.key)) {
            haveToDraw = this.actions.deleteAction.execute(event);
          }
          if (this.pluginData.configuration.keysBinding.selectAll.includes(event.key)) {
            haveToDraw = this.actions.selectionAll.execute(event);
          }
          if (this.pluginData.configuration.keysBinding.deselectAll.includes(event.key)) {
            haveToDraw = this.actions.deselectionAll.execute(event);
          }

          if (haveToDraw) {
            this.draw();
          }
        })
        .on('keyup', (event) => {
          let haveToDraw = false;

          if (this.pluginData.configuration.keysBinding.selection.includes(event.key)) {
            this.states.selection = false;
          }
          if (this.pluginData.configuration.keysBinding.deleteObject.includes(event.key)) {
            haveToDraw = this.actions.deleteAction.finalize(event);
          }
          if (this.pluginData.configuration.keysBinding.selectAll.includes(event.key)) {
            haveToDraw = this.actions.selectionAll.finalize(event);
          }
          if (this.pluginData.configuration.keysBinding.deselectAll.includes(event.key)) {
            haveToDraw = this.actions.deselectionAll.finalize(event);
          }

          if (haveToDraw) {
            this.draw();
          }
        });
    }

    const drag = this.d3.drag()
      .subject((event) => {
        const element = event.sourceEvent.target.closest('.component');

        this.states.resizing = !!event.sourceEvent.target.closest('.resize-button');
        this.states.menuOpening = !!event.sourceEvent.target.closest('.menu-button');

        if (!element) {
          return this.scene;
        }
        const subject = this.viewport.select(Array.from(element.classList)
          .map((value) => `.${value}`)
          .join(''));

        this.states.linking = !!event.sourceEvent.target.closest('.anchor')
          &amp;&amp; this.pluginData.canHaveLink(subject.datum().data.definition.type);

        return subject;
      })
      .on('drag', (event) => {
        this.states.moving = true;

        const isScene = event.subject.datum().data.id === 'scene';
        let haveToDraw = false;

        if (this.readOnly) {
          this.actions.dragScene.execute(event);

          return;
        }

        if (isScene) {
          haveToDraw = this.actions.dragScene.execute(event);
        } else if (this.states.linking) {
          haveToDraw = this.actions.link.execute(event);
          this.linkRenderer.render();
        } else if (this.states.resizing) {
          haveToDraw = this.actions.resizeComponent.execute(event);
          this.linkRenderer.render();
        } else {
          haveToDraw = this.actions.dragComponent.execute(event);
          this.linkRenderer.render();
        }

        if (haveToDraw) {
          this.draw();
        }
      })
      .on('end', async (event) => {
        const hasMoved = this.states.moving;
        const isSelected = this.states.selection;
        const isMenuOpening = this.states.menuOpening;
        const isResizing = this.states.resizing;
        const isLinking = this.states.linking;
        const isScene = event.subject.datum().data.id === 'scene';
        let haveToDraw = false;

        if (this.readOnly) {
          if (isScene &amp;&amp; hasMoved) {
            this.actions.dragScene.finalize(event);
          }

          return;
        }

        if (isLinking) {
          // LINKING PARK - in the end!!!!
          haveToDraw = this.actions.link.finalize(event);
        } else if (hasMoved &amp;&amp; isScene) {
          haveToDraw = this.actions.dragScene.finalize(event);
        } else if (isResizing) {
          haveToDraw = this.actions.resizeComponent.finalize(event);
        } else if (hasMoved &amp;&amp; !isScene) {
          haveToDraw = this.actions.dragComponent.finalize(event);
        } else if (!hasMoved &amp;&amp; isMenuOpening) {
          haveToDraw = this.actions.menuAction.finalize(event);
        } else if (!hasMoved &amp;&amp; !isScene &amp;&amp; isSelected) {
          haveToDraw = this.actions.toggleSelection.finalize(event);
        }

        if (haveToDraw) {
          this.draw();
        }

        this.states.moving = false;
      });

    this.viewport.call(drag);
  }

  /**
   * Get scene width data.
   * @returns {object} D3 selection of scene.
   */
  getScene() {
    return this.viewport
      .selectAll('.scene')
      .data(this.getSceneData())
      .join('svg')
      .attr('class', 'scene')
      .attr('width', '100%')
      .attr('height', '100%');
  }

  /**
   * Initialize the scene, set all markers component and link groups.
   */
  initScene() {
    this.viewport
      .append('style')
      .text(this.pluginData.resources.style);
    this.scene = this.getScene();
    this.scene.attr('version', '1.1');
    this.scene.attr('xmlns', 'http://www.w3.org/2000/svg');

    this.scene.append('defs').html(
      Object.keys(this.pluginData.resources.markers)
        .map((key) => this.pluginData.resources.markers[key])
        .join(''),
    );
    const { x, y, zoom } = this.pluginData.scene;
    const transform = `translate(${x} ${y}) scale(${zoom})`;

    this.scene.append('g')
      .attr('class', 'components')
      .attr('transform', transform);
    this.scene.append('g')
      .attr('class', 'links')
      .attr('transform', transform);
  }

  /**
   * Components driven drawing.
   */
  draw() {
    this.scene = this.getScene();

    this.componentRenderer.render('scene');
    this.linkRenderer.render('scene');

    if (this.readOnly) {
      const { width: vWidth, height: vHeight } = this.viewport.node().getBoundingClientRect();
      const {
        width,
        height,
        x,
        y,
      } = this.viewport.select('.scene .components').node().getBBox();
      const ratio = vWidth / width &lt; vHeight / height ? vWidth / width : vHeight / height;
      let zoom = 1;

      while (zoom > ratio) {
        zoom *= 0.9;
      }

      this.scene.attr('viewBox', `${x - 15} ${y - 15} ${width + x + 15} ${height + y + 15}`);
      this.pluginData.scene.zoom = zoom;
    }
  }

  /**
   * Reorganize position and size of all components.
   * This method does not refresh the view. You have to await it and trigger a redraw.
   * @param {string} id - The container within which we need to organize the children,
   * and if not specified, all components will be reorganized.
   * @param {boolean} keepPosition -  If true only component without position will be reorganized.
   */
  arrangeComponentsPosition(id, keepPosition) {
    this.layout.generateComponentsLayout(id, keepPosition);
  }

  /**
   * Resize the container to its minimum size.
   * @param {string} id - Container id.
   */
  resize(id) {
    this.layout.resize(id);
  }

  /**
   * Format component dataset to d3 hierarchy.
   * @returns {object} - Formated component dataset.
   */
  getSceneData() {
    return [
      this.d3.hierarchy(
        {
          id: 'scene',
          name: '',
          children: [
            ...this.pluginData.components
              .filter((component) => component.getContainerId() === null),
          ],
          ...this.pluginData.scene,
        },
        (data) => {
          if (data.id === 'scene') {
            return data.children;
          }

          return this.pluginData.getChildren(data.id);
        },
      ),
    ];
  }

  /**
   * Drop component on scene.
   * @param {Component} component - Component to drop.
   * @param {object} event - Mouse event.
   */
  dropComponent(component, event) {
    const target = event.target.closest('.component');

    component.drawOption.width = component.definition.width;
    component.drawOption.height = component.definition.height;

    if (!target) {
      const { x: sceneX, y: sceneY } = this.viewport.select('.scene')
        .node().getBoundingClientRect();

      component.drawOption.x = (event.clientX - sceneX - this.pluginData.scene.x)
        / this.pluginData.scene.zoom - component.definition.defaultWidth / 2;
      component.drawOption.y = (event.clientY - sceneY - this.pluginData.scene.y)
        / this.pluginData.scene.zoom - component.definition.defaultHeight / 2;

      return;
    }

    if (target.canContain(component.definition.type)) {
      const { x: containerX, y: containerY } = this.viewport
        .select(`.${component.id}.container`).node().getBoundingClientRect();

      component.drawOption.x = (event.clientX - containerX - this.pluginData.scene.x)
        / this.pluginData.scene.zoom - component.definition.defaultWidth / 2;
      component.drawOption.y = (event.clientY - containerY - this.pluginData.scene.y)
        / this.pluginData.scene.zoom - component.definition.defaultHeight / 2;
    }
  }

  /**
   * Export viewport as svg.
   * @returns {string} Svg content.
   */
  exportSvg() {
    this.viewport.selectAll('.scene > g').attr('transform', '');

    return document.querySelector('#view-port .scene').outerHTML;
  }
}

export default DefaultDrawer;
</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.3</a></p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>

<script src="scripts/search.js"> </script>


</body>
</html>
